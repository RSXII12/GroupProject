<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>iBay Home</title>
        <link rel="stylesheet" href="buyerPage.css">
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script> 
        <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
        <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
        <script>
            $(function() {
                $("#price-slider").slider({
                    range: true,
                    min: 0,
                    max: 500,
                    values: [0, 500],
                    slide: function(event, ui) {
                        $("#price-range").val("£" + ui.values[0] + " - £" + ui.values[1]);
                        $("#price-range-label").text("£" + ui.values[0] + " - £" + ui.values[1]);
                    }
                });
        
                $("#price-range").val("£" + $("#price-slider").slider("values", 0) +
                    " - £" + $("#price-slider").slider("values", 1));
                $("#price-range-label").text("£" + $("#price-slider").slider("values", 0) +
                    " - £" + $("#price-slider").slider("values", 1));
            });
        
            function performSearch() {
                console.log("Search button clicked!");

                const searchText = $('#search-field').val();
                const [minPrice, maxPrice] = $("#price-slider").slider("values");
                const timeRemaining = $('#time-remaining').val();
                const location = $('#location').val();
                const department = $('#department').val();  // Get selected department

                // Create an object for our parameters
                const params = {};
                
                // Only add parameters that are actually set by the user
                if (searchText) params.searchText = searchText;
                
                // Only apply price filter if it's not at default values
                const defaultMinPrice = 0;
                const defaultMaxPrice = 500;
                if (minPrice !== defaultMinPrice || maxPrice !== defaultMaxPrice) {
                    params.minPrice = minPrice;
                    params.maxPrice = maxPrice;
                }
                
                if (timeRemaining) params.timeRemaining = timeRemaining;
                if (location) params.location = location;
                if (department) params.department = department;  // Add department to params

                $.ajax({
                    url: 'search.php',  
                    type: 'GET',
                    dataType: 'json',
                    data: params,  // Send all the parameters in the AJAX request
                    success: function(items) {
                        console.log("Results:", items);
                        displayResults(items);  // Call function to display the results
                    },
                    error: function(xhr, status, error) {
                        console.error("AJAX Error:", error);
                        console.log(xhr.responseText);
                    }
                });
            }

            function formatTime(seconds) {
                const days = Math.floor(seconds / (3600 * 24));
                seconds %= 3600 * 24;
                const hours = Math.floor(seconds / 3600);
                seconds %= 3600;
                const minutes = Math.floor(seconds / 60);
                seconds = Math.floor(seconds % 60);

                return `${days}d ${hours}h ${minutes}m ${seconds}s`;
            }
        
            function displayResults(items) {
                const container = document.querySelector(".main-content");
                
                // Check if there is already a results container and remove it
                let existingResults = container.querySelector(".search-results");
                if (existingResults) {
                    existingResults.remove();  // Remove the old results if present
                }

                // Create a new div to hold the results
                const resultsDiv = document.createElement("div");
                resultsDiv.classList.add("search-results");
                
                let html = "";

                if (!items.length) {
                    html += "<p>No matching items found.</p>";
                } else {
                    items.forEach(item => {
                        html += `
                            <div class="result-card">
                                <div class="image-container">
                                    <img src="${item.image}" alt="${item.title}">
                                </div>
                                <div class="content">
                                    <h4>${item.title}</h4>
                                    <p class="category"><strong>Department:</strong> ${item.category}</p>
                                    <p class="time-remaining"><strong>Time remaining:</strong> ${formatTime(item.time_remaining * 3600)}</p>
                                    <p class="price"><strong>Price:</strong> £${item.price} (+ £${item.postage} postage)</p>
                                    <p class="location"><strong>Location:</strong> ${item.location}</p>
                                </div>
                            </div>
                        `;
                    });
                }

                resultsDiv.innerHTML = html;

                // Append the new results below the search bar
                container.appendChild(resultsDiv);
            }
        
            document.addEventListener("DOMContentLoaded", function() 
            {
                // Check for category in URL and auto-set the filter
                const urlParams = new URLSearchParams(window.location.search);
                const category = urlParams.get("category");

                if (category) 
                {
                    const departmentSelect = document.getElementById("department");
                    departmentSelect.value = category;
                }

                 // Wait a tiny bit to ensure UI like the price slider is ready, then trigger search
                    setTimeout(() => {
                        performSearch();
                    }, 100);
                // Wire both buttons to performSearch
                document.getElementById("search-button").addEventListener("click", performSearch);
                document.getElementById("apply-filters").addEventListener("click", performSearch);
            });
        </script>
    </head>
    <body>
        <div class="header">
            <span>Please <a href="sellerLogin.html">Log in</a> or <a href="sellerSignUp.html">Sign up</a> to use iBay</span>
            <a href="sellerPage.html" class="create-listing">Create a listing</a>
        </div>
    
        <div class="container">
            <div class="sidebar">
                <div class="logo" style="text-align: center; margin-bottom: 20px;">
                    <a href="index.php"><img src="iBay-logo.png" style="max-width: 150px; height: auto;"></a>
                </div>
                
                <div class="search-options">
                    <h3>Advanced Search</h3>
                    <label for="department">Department</label>
                    <select id="department" name="department" required>
                        <option value="">Select a department</option>
                        <option value="Technology">Technology</option>
                        <option value="Clothing">Clothing</option>
                        <option value="Home & Garden">Home & Garden</option>
                    </select>
                    <label for="price-range">Price Range:</label>
                    <input type="text" id="price-range" readonly style="border:0;">
                    <div id="price-slider"></div>
                    <label for="time-remaining">Time Remaining (hours)</label>
                    <input type="number" id="time-remaining" min="1" placeholder="Enter hours">
                    <label for="location">Location</label>
                    <input type="text" id="location" placeholder="Enter location">
                    <button id="apply-filters">Apply Filters</button>
                </div>
            </div>
    
            <div class="main-content">
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="search-field" class="search-bar" placeholder="Search field">
                    <button id="search-button">Search</button>
                </div>
                
            </div>
        </div>
    
        <div class="footer">
            Copyright @2025-25 iBay Inc. All rights reserved
        </div>
    </body>
</html>
